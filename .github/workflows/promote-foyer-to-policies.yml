name: Promote /foyer/ (or /echo/policies/) → /policies/ (Owner-only)

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: "Source branch containing reviewed foyer/echo/policies changes (optional)"
        required: false
        default: ""
      promotion_note:
        description: "Short owner promotion note"
        required: false
        default: "Owner-approved promotion to /policies/"

jobs:
  promote-to-policies:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Ensure caller is Repository Owner
        run: |
          echo "Triggered by: $GITHUB_ACTOR"
          if [ "${GITHUB_ACTOR}" != "good4usoul-caene" ]; then
            echo "Only the Repository Owner (good4usoul-caene) may run this promotion workflow."
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Determine source branch
        id: src
        run: |
          if [ -n "${{ github.event.inputs.source_branch }}" ]; then
            echo "source_branch=${{ github.event.inputs.source_branch }}" >> $GITHUB_OUTPUT
          else
            branch=$(git ls-remote --heads origin 'bot/stage-foyer-*' | awk '{print $2}' | sed 's|refs/heads/||' | sort -r | head -n1)
            if [ -z "$branch" ]; then
              branch="main"
            fi
            echo "source_branch=$branch" >> $GITHUB_OUTPUT
          fi
          echo "Using source branch: ${{ steps.src.outputs.source_branch }}"

      - name: Fetch and checkout source branch
        run: |
          git fetch origin ${{ steps.src.outputs.source_branch }}:refs/remotes/origin/${{ steps.src.outputs.source_branch }} || true
          git checkout -b promote-from-${{ steps.src.outputs.source_branch }} origin/${{ steps.src.outputs.source_branch }} || git checkout -b promote-from-${{ steps.src.outputs.source_branch }}

      - name: Validate Promotion-Ready front-matter in foyer or echo/policies files
        id: validate
        run: |
          missing=""
          for DIR in foyer echo/policies; do
            if [ -d "$DIR" ]; then
              while IFS= read -r -d '' file; do
                if ! grep -qE '^Promotion-Ready:[[:space:]]*owner-approved' "$file"; then
                  missing="${missing}\n${file}"
                fi
              done < <(find "$DIR" -type f -print0)
            fi
          done

          if [ -n "$missing" ]; then
            echo "The following files lack 'Promotion-Ready: owner-approved' in front-matter:"
            echo -e "$missing"
            exit 2
          else
            echo "All candidate files have Promotion-Ready: owner-approved"
          fi

      - name: Copy foyer / echo/policies files into /policies/
        id: copy
        run: |
          promoted=""
          mkdir -p policies
          for DIR in foyer echo/policies; do
            if [ -d "$DIR" ]; then
              while IFS= read -r -d '' file; do
                filename="$(basename "$file")"
                cp "$file" "policies/$filename"
                promoted="${promoted}\n${file} -> policies/${filename}"
              done < <(find "$DIR" -type f -print0)
            fi
          done
          echo -e "promoted_list:${promoted}"
          echo "promoted_list<<EOF" >> $GITHUB_OUTPUT
          echo -e "${promoted}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          git add policies || true

      - name: Create Promotion Record
        if: steps.copy.outputs.promoted_list != ''
        run: |
          timestamp=$(date -u +"%Y%m%dT%H%M%SZ")
          record="pasture/archive/promotion-record-${timestamp}.md"
          mkdir -p pasture/archive
          cat > "${record}" <<EOF
---
Promoted-By: $GITHUB_ACTOR
Promotion-Time: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
Source-Branch: ${{ steps.src.outputs.source_branch }}
Note: ${{ github.event.inputs.promotion_note }}
Files-Promoted:
${{ steps.copy.outputs.promoted_list }}
---
Owner-authorized promotion record for /policies/.
EOF
          git add "${record}"

      - name: Commit promotion changes
        run: |
          if git diff --staged --quiet; then
            echo "No staged changes to commit."
            exit 1
          else
            git commit -m "Bot: promote → /policies/ (run ${{ github.run_id }})" || true
          fi

      - name: Create Promotion PR
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.BOT_PAT }}
          commit-message: "Bot: promote → /policies/ (run ${{ github.run_id }})"
          branch: "bot/promote-policies-${{ github.run_id }}"
          title: "Promote /foyer/ artifacts to /policies/ (owner confirmed)"
          body: |
            Owner-triggered promotion of foyer/echo/policies artifacts to /policies/.
            Promotion Record: pasture/archive/promotion-record-<timestamp>.md
            NOTE: This PR must be reviewed and merged per branch protection rules. Do not merge without SEARCH‑AND‑INSERT confirmation.
          labels: "auto-promote, needs-review"
