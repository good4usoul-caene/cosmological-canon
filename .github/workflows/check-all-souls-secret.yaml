# Filename: .github/workflows/check-all-souls-secret.yaml
# Author: TTRPG- Copilot Agent
# User-Request: "Add diagnostic workflows before PR" / "Verify ALL_SOULS_TOKEN and minimal read permissions"
# Purpose: Manual test to confirm the repository secret ALL_SOULS_TOKEN is present and can authenticate a harmless read via the GitHub API.
name: Check ALL_SOULS_TOKEN secret

on:
  workflow_dispatch:

jobs:
  check-secret:
    runs-on: ubuntu-latest
    steps:
      - name: Report runner & repo
        run: |
          echo "Runner: $RUNNER_OS"
          echo "Repository: $GITHUB_REPOSITORY"
      - name: Check for ALL_SOULS_TOKEN presence
        run: |
          if [ -z "${{ secrets.ALL_SOULS_TOKEN }}" ]; then
            echo "::error::Secret ALL_SOULS_TOKEN is NOT set in this repository."
            exit 1
          else
            echo "Secret ALL_SOULS_TOKEN is present."
          fi
      - name: Sanity-check token scopes (safe read)
        env:
          REPO_TOKEN: ${{ secrets.ALL_SOULS_TOKEN }}
        run: |
          # Perform a harmless API call to confirm token works (rate-limited; does not expose token)
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token ${REPO_TOKEN}" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}")
          if [ "$RESPONSE" = "200" ]; then
            echo "API read succeeded (HTTP 200). Token can read repo metadata."
          else
            echo "::error::API read returned HTTP $RESPONSE. Token may lack read permission or is invalid."
            exit 2
          fi
