# Author: TTRPG- Copilot Agent
# User-Request: "Add diagnostic workflows before PR" / "Add permissions for writing contents and creating pull requests"
# Purpose: Create or update files under /TTRPG/Heretics/, push to branch ttrpg/setup-templates, and open a Pull Request.
# Notes:
#  - Uses secrets.ALL_SOULS_TOKEN for authenticated push & PR creation.
#  - Detects repository default branch (origin/HEAD) and uses it as PR base.
#  - Idempotent branch handling so repeated runs are safe.
#  - Commits only when changes exist and only pushes if commit succeeds.
#  - Retries pushes and PR creation to handle transient failures.
name: Create TTRPG files (Heretics starter)

on:
  workflow_dispatch:

jobs:
  create-files:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Configure git user
        run: |
          git config user.name "TTRPG- Copilot Agent"
          git config user.email "ttrpg-bot@example.com"

      - name: Ensure jq is available
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Detect default branch and create/switch to idempotent branch
        id: branch-info
        run: |
          set -euo pipefail
          # Detect remote default branch (origin/HEAD -> origin/main or origin/master)
          DEFAULT_REF=$(git remote show origin | sed -n 's/.*HEAD branch: //p' | tr -d '\r\n')
          if [ -z "${DEFAULT_REF:-}" ]; then
            # try origin/HEAD symbolic-ref fallback
            DEFAULT_REF=$(git symbolic-ref --short refs/remotes/origin/HEAD 2>/dev/null || true)
            DEFAULT_REF=${DEFAULT_REF#origin/}
          fi
          DEFAULT_REF=${DEFAULT_REF:-main}
          echo "Detected default branch: $DEFAULT_REF"
          echo "DEFAULT_REF=$DEFAULT_REF" >> $GITHUB_OUTPUT

          BRANCH="ttrpg/setup-templates"
          echo "Working branch: $BRANCH"
          # Fetch latest and create/force local branch from origin/<DEFAULT_REF>
          git fetch origin --prune
          if git show-ref --verify --quiet "refs/remotes/origin/${DEFAULT_REF}"; then
            git checkout -B "$BRANCH" "origin/${DEFAULT_REF}"
          else
            # fallback: create branch from current HEAD (safe, but warn)
            echo "::warning::origin/${DEFAULT_REF} not found; creating $BRANCH from current HEAD"
            git checkout -B "$BRANCH"
          fi
          echo "BRANCH=$BRANCH" >> $GITHUB_OUTPUT

      - name: Create directories
        run: |
          mkdir -p TTRPG/Heretics/Characters
          mkdir -p TTRPG/Heretics/Chronicles/encounters

      - name: Write files (approved content)
        run: |
          set -euo pipefail
          # Corra-Voss-knowledge.md
          cat > TTRPG/Heretics/Characters/Corra-Voss-knowledge.md <<'EOF'
--- 
Filename: Corra-Voss-knowledge.md
Ultimate-Target-Directory: /TTRPG/Heretics/Characters/
Version: 2025-11-01v1
Prev-Version: none
Author: Organizationel â€“ Chroniclekeeper
Proposed-By: good4usoul-caene
Date: 2025-11-01
Genre: PC Hooks / Character Notes
RitualNote: Player-character hooks and brief arcs for the campaign's core PCs, compiled for Corra Voss's knowledge file. Staged to /TTRPG/Heretics/Characters/ per user request.
Change-Note: Imported PC Hooks: The Four Defiers of the Singular Gaze and associated character arcs for use as session hooks and play prompts.
Posture: draft/player-facing
Proposed-Path: /TTRPG/Heretics/Characters/Corra-Voss-knowledge.md
---

ðŸ”® PC Hooks: The Four Defiers of the Singular Gaze

ðŸ§™â€â™‚ï¸ 1. The Wizard: Archivist of Forbidden Names  
Origin: Discovered a codex beneath the collapsed temple containing erased divine names. Belief Status: Agnostic, seeking proof through arcane logic. Conflict: Each name invoked risks divine punishmentâ€”but also unlocks forgotten power. Arc: Must decide whether to restore the pantheons or prove Pascalâ€™s God is the only one. 

âš”ï¸ 2. The Fighter: Blade of the Broken Oath â€” Corra Voss  
Origin: Wields a weapon forged from shattered divine covenants. Belief Status: Disillusioned believer, once loyal to Pascalâ€™s God. Conflict: The blade grows stronger when oaths are broken, but hungers for divine blood. Arc: Must choose whether to restore the original oath or forge a new divine pact. 

ðŸŒ¿ 3. The Druid: Grovekeeper of Converging Realms  
Origin: Secret guardian of the last living grove, which blooms across multiple pantheons. Belief Status: Heretic, believes the grove itself is divine. Conflict: The grove is regularly cleared of heretics by the Clerisy of the Gaze. Arc: Must decide whether to open the grove to all or seal it from divine war.

ðŸª“ 4. The Barbarian: Vessel of the Forgotten God  
Origin: Possessed by a god whose name was erased from all pantheons. Belief Status: Apostate, seeks to destroy Pascalâ€™s God. Conflict: Rage is divine, but uncontrollable. The god within may be more dangerous than the one above. Arc: Must choose whether to become the godâ€™s avatar or purge it from existence. 

ðŸŽ¼ 5. The Bard: Voice of the Forbidden Hymn  
Origin: Raised in the Choir of the Gaze, trained to sing only of Pascalâ€™s glory. But one day, the bard heard a melody in a dreamâ€”an ancient hymn from a forgotten god. Belief Status: Torn between indoctrination and inspiration. Conflict: Their voice can stir divine memory in others, awakening suppressed pantheons. But each performance risks damnation. Arc: Must choose whether to become a prophet of polyphony or silence the forbidden song forever.

ðŸ™ 6. The Cleric: Apostate of the Dual Flame  
Origin: Once a devout servant of Pascalâ€™s God, the cleric now secretly communes with two exiled deitiesâ€”one of mercy, one of wrath. Belief Status: Apostate, but still haunted by the fear of hell. Conflict: Their miracles flicker between Pascalâ€™s sanctioned light and the dual flame of rebellion. Arc: Must decide whether to renounce Pascal entirely, reconcile the flames, or become a martyr.

ðŸ•µï¸ 7. The Rogue: Whisperer of the Shimmering Veil  
Origin: Discovered the shifting boundary to the Grove of Converging Realms and now acts as a smuggler of divine relics and forbidden truths. Belief Status: Cynical opportunist, believes in gods only as leverage. Conflict: The rogue is hunted by the Clerisy, but protected by the Groveâ€”so long as they donâ€™t betray it. Arc: Must choose whether to sell the Groveâ€™s secrets, protect its sanctity, or become its unseen guardian. 

âš–ï¸ 8. The Paladin: Oathbound to the Silent Throne  
Origin: Swore an oath to Pascalâ€™s God in youth, believing in the promise of eternal heaven. But now, the paladin has seen the throneâ€”and it is silent, unmoving, unfeeling. Belief Status: Disillusioned, but still bound by divine contract. Conflict: Their oath grants power, but also chains. Breaking it may unleash divine wrathâ€”or divine freedom. Arc: Must decide whether to uphold the oath, rewrite it, or shatter it and face the consequences. 

---
Provenance: Compiled from user-provided PC Hooks snippet; staged to /TTRPG/Heretics/Characters/ for GM and players to reference.  
Change-Note: Created 2025-11-01T02:00:30Z â€” ready for review/promulgation.
EOF

          # Elara-Keene-Bard.md
          cat > TTRPG/Heretics/Characters/Elara-Keene-Bard.md <<'EOF'
---
Filename: Elara-Keene-Bard.md
Ultimate-Target-Directory: /TTRPG/Heretics/Characters/
Version: 2025-11-05v1
Prev-Version: none
Author: Organizationel â€“ LoreWeaver
Proposed-By: good4usoul-caene
Date: 2025-11-05
Genre: Character Sheet / Pregen
RitualNote: Levelâ€‘1 Bard (Voice of the Forbidden Hymn archetype). Playable PC for Destarie/Heretics.
Change-Note: Includes short knowledge file and play hooks for opening scene.
Posture: draft/player-facing
---

# Elara Keene â€” Voice of the Forbidden Hymn (Level 1 Bard)

One-line pitch
- Elara sings what shouldn't be sung: useful charm, dangerous melodies, and hidden knowledge in verse.

Basics
- Player: (TBD)  
- Pronouns: she/her  
- Appearance: Slight, quickâ€‘smiling, choirâ€‘trained carriage; clothes with faint choir-braid marks hidden under a traveler's cloak.

Race / Heritage
- Human (+1 to two ability scores or variant). Using simple stat bumps: +1 CHA, +1 DEX.

Ability scores (pregenerated)
- STR 8 (-1)  
- DEX 14 (+2)  
- CON 12 (+1)  
- INT 11 (+0)  
- WIS 10 (+0)  
- CHA 16 (+3)

Derived
- Level: 1 (Bard)  
- HP: 8 (d8) + CON (+1) = 9 HP  
- AC: Leather (11 + DEX 2) = 13 (typical)  
- Speed: 30 ft  
- Proficiency bonus: +2  
- Initiative: +2 (DEX)

Proficiencies & gear
- Armor: Light armor  
- Weapons: Simple weapons, longsword, rapier, shortbow, hand crossbow  
- Tools: Lute (proficiency), Calligrapherâ€™s supplies (for hymn fragments)  
- Languages: Common, Choir Cant (ritual cant), one regional tongue (Virelian)  
- Starting kit: Rapier, lute, leather armor, explorerâ€™s pack, choir token, 10 gp

Skills (choose 4 typical for Bard; pregenned)
- Persuasion +5 (CHA +3 + prof +2)  
- Performance +5  
- Insight +2 (WIS +0 + prof +2)  
- Deception +5

Class features
- Bardic Inspiration (d6) â€” 1 use at L1 (grant an ally a d6 to add to roll; short rest recover).  
- Spellcasting: 2 cantrips known (Vicious Mockery, Minor Illusion) ; 2 levelâ€‘1 spells prepared (Charm Person, Healing Word / or Sleep). Use spells as social and subtle support.

Personality & roleplay
- Hook: Raised in the Choir of the Gaze; the forbidden hymn came to her in a dream. She keeps fragments on parchment and hums half-lines when nervous.
- Quirk: Taps a rhythm on surfaces while thinking; sings insults as lullabies.
- Personality: Warm, coaxing, and a little tragically nostalgic for chorales she once believed in.

Short background / knowledge (what Elara knows inâ€‘character)
- Where sheâ€™s from: Raised in the Choir halls of CaelumbrÃ©; knows basilica protocol, choir ranks, and how official blessings are sold. She can read liturgical scrolls and recognize official seals.
- Where she goes: The basilica, back alleys with sympathetic choristers, taverns where ex-choir members gather, the outskirts grove where forbidden hymns echo.
- Contacts: A choir elder sympathetic to dissent (Aunt Nael), a tavern host who sells quiet rooms (Moss Marn), and a minor archivist who will copy a page for coin (Lito).
- What she fears: Public damnation and being silenced; she prefers subtle subversion.
- What she wants: To sing the forbidden line in safety or to find proof the hymn is more than a dream.

Trust & relationships (opening scene)
- Trusts Corra as a firm, steady protector (practical trust) â€” he kept a scholar safe once.  
- Works with the Rogue when needed; understands trade-in-secrets dynamic.  
- Wary of Paladin types; choir training makes her sensitive to clerical scrutiny.

Combat / social tactics (L1)
- Open with Charm Person or Bardic Inspiration to sway guards or mark targets.
- Use Minor Illusion or Performance to create a distraction for a heist.
- Avoid frontline; keep distance and support allies while nudging social beats.

Notes for GM: keep Elara evocative but playerâ€‘led. Let her song be an inciting tool (a single line can turn crowds or calm a Barbarian); donâ€™t let NPCs "use" the hymn to overrule player choices.

Quick reference
- AC 13 / HP 9 / Speed 30 / Str8 Dex14 Con12 Int11 Wis10 Cha16  
- Skills: Persuasion +5, Performance +5, Insight +2, Deception +5  
- Tools: Lute, Calligrapherâ€™s supplies
EOF

          # Lys Whisper
          cat > TTRPG/Heretics/Characters/Lys-Whisper-Rogue.md <<'EOF'
---
Filename: Lys-Whisper-Rogue.md
Ultimate-Target-Directory: /TTRPG/Heretics/Characters/
Version: 2025-11-05v1
Prev-Version: none
Author: Organizationel â€“ LoreWeaver
Proposed-By: good4usoul-caene
Date: 2025-11-05
Genre: Character Sheet / Pregen
RitualNote: Levelâ€‘1 Rogue (Whisperer archetype). Playable PC for Destarie/Heretics. (formerly Rook Vance)
Change-Note: Renamed to Lys Whisper per user; includes short knowledge file and play hooks for opening scene.
Posture: draft/player-facing
---

# Lys Whisper â€” Whisperer of the Shimmering Veil (Level 1 Rogue)

One-line pitch
- Lys moves where edges blur: expert at lifting the ledger, slipping past eyes, and reading which door to knock.

Basics
- Player: (TBD)  
- Pronouns: they/them  
- Appearance: Spare, hooded, quick hands and eyes; halfâ€‘smile that doesnâ€™t reach their eyes. Wears a patched cloak with hidden pockets.

Race / Heritage
- Human (variant) â€” +1 DEX, +1 INT.

Ability scores (pregenerated)
- STR 10 (+0)  
- DEX 16 (+3)  
- CON 12 (+1)  
- INT 13 (+1)  
- WIS 12 (+1)  
- CHA 10 (+0)

Derived
- Level: 1 (Rogue)  
- HP: 8 (d8) + CON (+1) = 9 HP  
- AC: Leather (11 + DEX 3) = 14 (typical)  
- Speed: 30 ft  
- Proficiency bonus: +2  
- Initiative: +3 (DEX)

Proficiencies & gear
- Armor: Light armor  
- Weapons: Shortsword, dagger, shortbow, hand crossbow  
- Tools: Thievesâ€™ tools (proficient), Disguise kit (optional)  
- Languages: Common, Cant of the Veil (underworld jargon)  
- Starting kit: Shortsword, 2 daggers, thievesâ€™ tools, burglarâ€™s pack, cloak with hidden pockets, 15 gp

Skills (pregenned)
- Stealth +5 (DEX +3 + prof +2)  
- Sleight of Hand +5  
- Perception +3 (WIS +1 + prof +2)  
- Investigation +3 (INT +1 + prof +2)

Class features
- Sneak Attack: +1d6 once per turn when conditions met.  
- Expertise at L1: Stealth and Sleight of Hand.

Personality & roleplay
- Hook: Grew up around the Grove fringe; knows routes and where to fence small artifacts. Profit and preservation blur.  
- Quirk: Flicks a coin when nervous; leaves a single black feather as a calling card.  
- Personality: Cool, pragmatic, with a hidden streak of loyalty for those who protect the grove.

Short background / knowledge (what Lys knows inâ€‘character)
- Where theyâ€™re from: Outskirts of Virelia and the market lanes of CaelumbrÃ©; knows city drains, alley codes, dead drops, and who watches which guard.
- Where they go: Market backstreets, fence houses, the Whispering Row where relic buyers meet, and the groveâ€™s outer paths for discreet trades.
- Contacts: "Moss" (tavern keeper), "Greev" (fence with a conscience), a scout in the militia who looks the other way for a price.
- What they want: Information and a steady line of trade; for this job, the ledger will net coin and leverage.
- What they fear: Being set up by bigger players (Clerisy, Paladin), and losing the Rogers' Row families who sheltered them.

Trust & relationships (opening scene)
- Works smoothly with Elara (theyâ€™ve traded songs for safe passage).  
- Respects Corra for reliability in tight spots â€” practical trust.  
- Suspicious of Aldric Vale (paladin); will plan for contingencies if he intervenes.

Tactics (heist role)
- Primary objective: slip into a stall/storage, lift a ledger page or sealed evidence, and exit unnoticed.  
- Use Stealth + Sleight of Hand; set up with Elaraâ€™s distraction. If discovered, use the environment (crowd, stalls) to break line of sight. Use Sneak Attack opportunistically if combat occurs.
- If arrested: attempt Deception and Persuasion to muddy the Paladinâ€™s formal case, or create a smoke/distract with Minor Illusion from Bard.

Quick mechanical reference
- AC 14 / HP 9 / Speed 30 / Str10 Dex16 Con12 Int13 Wis12 Cha10  
- Skills: Stealth +5, Sleight of Hand +5, Perception +3, Investigation +3  
- Tools: Thievesâ€™ tools, Disguise kit
EOF

          # Aldra Vey
          cat > TTRPG/Heretics/Characters/Aldra-Vey-Archivist.md <<'EOF'
---
Filename: Aldra-Vey-Archivist.md
Ultimate-Target-Directory: /TTRPG/Heretics/Characters/
Version: 2025-11-05v1
Prev-Version: none
Author: Organizationel â€“ LoreWeaver
Proposed-By: good4usoul-caene
Date: 2025-11-05
Genre: NPC / Inscription Draft
RitualNote: NPC Wizard used as an agency figure in the opening encounter. Designed to be helpful as a plot device but not to overshadow players.
Change-Note: Minimal stat block and behavioral guidance for nonâ€‘player control.
Posture: draft/GM-facing
---

# Aldra Vey â€” Archivist of Forbidden Names (NPC Wizard, L1-ish)

One-line pitch
- Aldra is a cautious scholar who hoards erasures and reads what the clerisy would rather forget. She can be an ally, an unwitting complication, or a target for the heist.

Quick stat block (lightweight, non-CR)
- Level / Rank: Apprentice Archivist (wizardâ€‘like) â€” use spell and skill checks but avoid forceful action.  
- AC: 12 (robes + light protection)  
- HP: 8â€“12 (1d6 + CON)  
- Key Skills: Arcana +4, History +3, Investigation +3, Persuasion +1  
- Languages: Common, Choir Cant, Old Tongue

Spell-like abilities (choose simple L1 utility)
- Cantrips: Mage Hand, Light, Prestidigitation  
- 1stâ€‘level spells (2 slots): Detect Magic, Identify, and a single defensive/utility spell (Shield or Mage Armor) â€” GM discretion.

Inventory & tokens
- Small codex (erased names ledger) kept in a hidden satchel; a letter sealing showing clerisy interest; quill and inks, a small silver choir token.

Motivations & behavior
- Motivations: Preserve knowledge; avoid public scandal; test if the erased names have pattern. She fears clerical reprisal more than lawless thieves.
- Behavior: Passive unless threatened â€” tries to parley and stall. If exposed and surrounded, she will cry "Knowledge!" and attempt to hand off the ledger to a hidden contact or hide it.
- Decision rule for GM: Aldra should never force a solution on players. She can offer clues, trade (knowledge for protection), or be the MacGuffin (ledger owner).

How to use her without overriding players
- Make Aldra hint, stall, or flee rather than dominate the scene. She can hand a clue to players who negotiate well.
- If the players take the ledger, Aldra may react emotionally but will have few options to overpower the players â€” she can call a clerisy contact (introduce Paladin timing) to escalate consequences.
- Aldra's knowledge is a lever, not a solution. Players must decide how to use or publicize it.
EOF

          # Aldric Vale
          cat > TTRPG/Heretics/Characters/Aldric-Vale-Paladin.md <<'EOF'
---
Filename: Aldric-Vale-Paladin.md
Ultimate-Target-Directory: /TTRPG/Heretics/Characters/
Version: 2025-11-05v1
Prev-Version: none
Author: Organizationel â€“ LoreWeaver
Proposed-By: good4usoul-caene
Date: 2025-11-05
Genre: NPC / Inscription Draft
RitualNote: Paladin NPC who is investigating the wizard; meant to create stakes and moral friction in the opening encounter.
Change-Note: Lightweight stat block and behavioral guidance for GM use. (renamed from Seras Vonn)
Posture: draft/GM-facing
---

# Aldric Vale â€” Oathbound Investigator (Paladin NPC, L1-ish)

One-line pitch
- Aldric is a principled enforcer of the basilica, convinced something improper is afoot and determined to collect evidenceâ€”by process or force.

Quick stat block (lightweight)
- AC: 16 (chain or scale + shield)  
- HP: 12â€“16 (1d10 + CON-ish)  
- Attacks: Spear or longsword +4; damage 1d8 + 2  
- Key Skills: Intimidation +3, Insight +3, Religion +3, Investigation +2  
- Saving Throws: STR, CHA

Motivations & behavior
- Motivations: Uphold the oath; root out heresy; protect the public reputation of the basilica. He is not purely villainousâ€”he believes in rules and order.
- Behavior: Procedural and formal â€” will ask to inspect documents, will call for official seizure if convinced of wrongdoing. If threatened, will attempt to detain the offender and call reinforcements.
- Decision rule for GM: Aldric acts like a legal officer rather than a chaotic crusader; give players chances to talk, bargain, or misdirect before he arrests.

How to use Aldric without overshadowing players
- Aldric should present a clear obstacle and a moral spotlight, but not solve the story. Let him be a force that players must outâ€‘maneuver or persuade.  
- Timing is key: have Aldric appear either before the heist (gives a narrow window and tension) or arrive mid-heist (creates opportunity for distraction and consequences). Avoid having him immediately overpower the partyâ€”he should probe, question, and escalate if rebuffed.
EOF

          # market-heist encounter
          cat > TTRPG/Heretics/Chronicles/encounters/market-heist.md <<'EOF'
---
Filename: market-heist.md
Ultimate-Target-Directory: /TTRPG/Heretics/Chronicles/encounters/
Version: 2025-11-05v1
Prev-Version: none
Author: Organizationel â€“ LoreWeaver
Proposed-By: good4usoul-caene
Date: 2025-11-05
Genre: Encounter Plan / Session Seed
RitualNote: Opening encounter: a small heist at CaelumbrÃ© market that brings PC trio (fighter, bard, rogue) into contact/confrontation with an NPC wizard and a Paladin investigator.
Change-Note: Updated NPC names to use Lys Whisper (rogue) and Aldric Vale (paladin).
Posture: draft/GM-facing
---

Market Heist â€” Short Setup
- Location: CaelumbrÃ© market square, near the basilica steps and a bookstall where Aldra (Archivist) is displaying a sealed ledger page. Crowds, stalls, and the basilica procession create witness-rich context.
- PCs present: Corra (fighter), Elara (bard), Lys Whisper (rogue).
- NPCs: Aldra (wizard/archivist) â€” selling/guarding knowledge; Aldric Vale (paladin) â€” arrives investigating Aldra; minor enforcers (1â€“2) possible.
- Objective for PCs: Steal a specific ledger page / forbidden note that would be used by Aldric to seize Aldra's materials (or to incriminate somebody). Lys is the thief, Elara is the distraction, Corra covers/assists.

Primary beats (10â€“20 minute vignette)
1. Setup: Aldra parleying at a stall; Elara plays a quiet hymn to draw a small crowd (Performance check DC 12 to attract 1d6+2 onlookers). Lys scouts the stall and notes ledger location (Investigation DC 13 to spot hidden page / identify satchel).
2. Complication: Aldric Vale appears and politely demands to inspect Aldra's papers (Investigation/Insight DC 12 for Aldric to detect suspicious behavior). If Aldric lingers, the heist window narrows.
3. Execution: On signal, Elara executes a louder performance / illusion (Performance or Minor Illusion; DC 12 persuasion on crowd) while Lys slips behind and attempts Sleight of Hand to lift the ledger (Sleight of Hand DC 14; opposed Perception from stallkeeper or Investigation from Aldric).
4. Consequence: If successful, the PCs must exit through crowded streets (Stealth/Acrobatics checks, DC 12â€“14) or bluff past Aldric (Persuasion/Deception DC 13). If detected, a social confrontation with Aldric begins (Insight/Intimidation/Persuasion skill challenge), or combat if things escalate.

Suggested DCs & skill guidance (tune per table)
- Performance to distract crowd: DC 12 (easy), 14 (notable), 16 (exceptional)
- Investigation to spot ledger or hidden satchel: DC 13
- Sleight of Hand to lift/replace: DC 14 (opposed by stallkeeper/perception)
- Stealth to leave unnoticed: DC 13
- Persuasion vs Paladin to avoid arrest: DC 15 (Aldric is trained and formal)
- A failed theft may draw a minor scuffle: use a short, low-HP encounter (2 enforcers: AC 12â€“14, HP 6â€“10 each)
EOF

      - name: Stage & prepare commit
        id: stage
        run: |
          set -euo pipefail
          git add TTRPG/Heretics
          if git diff --staged --quiet; then
            echo "NO_CHANGES=1" >> $GITHUB_ENV
            echo "No staged changes to commit."
          else
            echo "NO_CHANGES=0" >> $GITHUB_ENV
            echo "Staged changes detected."
          fi

      - name: Commit changes if any
        id: commit
        run: |
          set -euo pipefail
          if [ "${NO_CHANGES:-1}" = "1" ]; then
            echo "Skipping commit: no changes."
            echo "COMMIT_OK=0" >> $GITHUB_ENV
            exit 0
          fi
          if git commit -m "TTRPG: add Heretics starter files and README"; then
            echo "COMMIT_OK=1" >> $GITHUB_ENV
            echo "Commit succeeded."
          else
            echo "COMMIT_OK=0" >> $GITHUB_ENV
            echo "::error::git commit failed."
            exit 1
          fi

      - name: Push branch using ALL_SOULS_TOKEN (only if commit succeeded)
        if: env.COMMIT_OK == '1'
        env:
          REPO_TOKEN: ${{ secrets.ALL_SOULS_TOKEN }}
        run: |
          set -euo pipefail
          BRANCH="ttrpg/setup-templates"
          git remote set-url origin https://x-access-token:${REPO_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
          for i in 1 2 3; do
            if git push --set-upstream origin "$BRANCH"; then
              echo "Push succeeded."
              break
            else
              echo "Push attempt $i failed; retrying..."
              sleep $((i*2))
            fi
          done

      - name: Create Pull Request (via API) with improved lookup & retry
        env:
          REPO_TOKEN: ${{ secrets.ALL_SOULS_TOKEN }}
        run: |
          set -euo pipefail
          BRANCH="ttrpg/setup-templates"
          DEFAULT_REF="${{ steps.branch-info.outputs.DEFAULT_REF }}"
          PR_TITLE="TTRPG: add Heretics starter files and README"
          PR_BODY="Adds initial Heretics campaign files under /TTRPG/Heretics/ (characters and one encounter). Please review; do not merge without owner review. Files added:\n- /TTRPG/Heretics/Characters/Corra-Voss-knowledge.md\n- /TTRPG/Heretics/Characters/Elara-Keene-Bard.md\n- /TTRPG/Heretics/Characters/Lys-Whisper-Rogue.md\n- /TTRPG/Heretics/Characters/Aldra-Vey-Archivist.md\n- /TTRPG/Heretics/Characters/Aldric-Vale-Paladin.md\n- /TTRPG/Heretics/Chronicles/encounters/market-heist.md\n- /TTRPG/Heretics/README.md"
          API_JSON=$(jq -n --arg title "$PR_TITLE" --arg body "$PR_BODY" --arg head "$BRANCH" --arg base "$DEFAULT_REF" '{title:$title, body:$body, head:$head, base:$base}')
          URL="https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls"
          for attempt in 1 2 3; do
            HTTP_CODE=$(curl -s -o response.json -w "%{http_code}" -X POST \
              -H "Authorization: token ${REPO_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              -H "Content-Type: application/json" \
              "$URL" -d "$API_JSON")
            if [ "$HTTP_CODE" = "201" ]; then
              PR_URL=$(jq -r .html_url response.json)
              echo "Pull request created: $PR_URL"
              echo "PR_URL=$PR_URL" >> $GITHUB_ENV
              exit 0
            elif [ "$HTTP_CODE" = "422" ]; then
              # search for any PR (open or closed) that uses this branch
              echo "422 response. Searching for existing PRs with head branch $BRANCH..."
              MATCH=$(curl -s -H "Authorization: token ${REPO_TOKEN}" "https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls?state=all" | jq -r --arg head "$BRANCH" '.[] | select(.head.ref==$head) | .html_url' | head -n1)
              if [ -n "$MATCH" ]; then
                echo "Found existing PR: $MATCH"
                echo "PR_URL=$MATCH" >> $GITHUB_ENV
                exit 0
              fi
            else
              echo "Attempt $attempt: create PR returned HTTP $HTTP_CODE. Response:"
              cat response.json || true
              sleep $((attempt*2))
            fi
          done
          echo "::error::Failed to create PR after retries. See response.json for details."
          cat response.json || true
          exit 1

      - name: Output PR URL or message
        run: |
          if [ -n "${PR_URL:-}" ]; then
            echo "PR created or found: ${PR_URL}"
          else
            echo "No PR URL available in environment. Check workflow logs for details."
          fi
