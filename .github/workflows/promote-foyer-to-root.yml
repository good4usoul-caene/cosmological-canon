name: Promote /foyer/ → repository root (Owner-only)

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: "Source branch containing reviewed /foyer/ changes (optional: leave blank to use latest bot staging branch)"
        required: false
        default: ""
      promotion_note:
        description: "Short owner promotion note"
        required: false
        default: "Owner-approved promotion to root"

jobs:
  promote-to-root:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Ensure caller is Repository Owner
        run: |
          echo "Triggered by: $GITHUB_ACTOR"
          if [ "${GITHUB_ACTOR}" != "good4usoul-caene" ]; then
            echo "Only the Repository Owner (good4usoul-caene) may run this promotion workflow."
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Determine source branch
        id: src
        run: |
          if [ -n "${{ github.event.inputs.source_branch }}" ]; then
            echo "source_branch=${{ github.event.inputs.source_branch }}" >> $GITHUB_OUTPUT
          else
            branch=$(git ls-remote --heads origin 'bot/stage-foyer-*' | awk '{print $2}' | sed 's|refs/heads/||' | sort -r | head -n1)
            if [ -z "$branch" ]; then
              branch="main"
            fi
            echo "source_branch=$branch" >> $GITHUB_OUTPUT
          fi
          echo "Using source branch: ${{ steps.src.outputs.source_branch }}"

      - name: Fetch and checkout source branch
        run: |
          git fetch origin ${{ steps.src.outputs.source_branch }}:refs/remotes/origin/${{ steps.src.outputs.source_branch }} || true
          git checkout -b promote-from-${{ steps.src.outputs.source_branch }} origin/${{ steps.src.outputs.source_branch }} || git checkout -b promote-from-${{ steps.src.outputs.source_branch }}

      - name: Validate Promotion-Ready front-matter in foyer files
        id: validate
        run: |
          missing=""
          if [ -d "foyer" ]; then
            while IFS= read -r -d '' file; do
              if ! grep -qE '^Promotion-Ready:[[:space:]]*owner-approved' "$file"; then
                missing="${missing}\n${file}"
              fi
            done < <(find foyer -type f -print0)
          else
            echo "No /foyer/ directory present. Nothing to promote."
            exit 1
          fi

          if [ -n "$missing" ]; then
            echo "The following foyer files are missing 'Promotion-Ready: owner-approved' in front-matter:"
            echo -e "$missing"
            exit 2
          else
            echo "All foyer files have Promotion-Ready: owner-approved"
          fi

      - name: Copy foyer files into repository root respecting Ultimate-Target-Directory
        id: copy
        run: |
          ts=$(date -u +"%Y%m%dT%H%M%SZ")
          promoted_list=""
          while IFS= read -r -d '' file; do
            filename="$(basename "$file")"
            target=$(grep -m1 '^Ultimate-Target-Directory:' "$file" | sed -E 's/^Ultimate-Target-Directory:[[:space:]]*//')
            target="${target#/}"
            if [ -z "$target" ]; then
              target="."
            fi
            mkdir -p "$target"
            cp "$file" "$target/$filename"
            promoted_list="${promoted_list}\n${file} -> ${target}/${filename}"
          done < <(find foyer -type f -print0)

          echo -e "Promoted files:${promoted_list}"
          echo "promoted_list<<EOF" >> $GITHUB_OUTPUT
          echo -e "${promoted_list}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          git add . || true

      - name: Create Promotion Record
        if: steps.copy.outputs.promoted_list != ''
        run: |
          timestamp=$(date -u +"%Y%m%dT%H%M%SZ")
          record="pasture/archive/promotion-record-${timestamp}.md"
          mkdir -p pasture/archive
          cat > "${record}" <<EOF
---
Promoted-By: $GITHUB_ACTOR
Promotion-Time: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
Source-Branch: ${{ steps.src.outputs.source_branch }}
Note: ${{ github.event.inputs.promotion_note }}
Files-Promoted:
${{ steps.copy.outputs.promoted_list }}
---
This promotion record documents the Owner-authorized promotion from /foyer/ to repository root.
EOF
          git add "${record}"

      - name: Commit promotion changes
        run: |
          if git diff --staged --quiet; then
            echo "No staged changes to commit."
            exit 1
          else
            git commit -m "Bot: promote /foyer/ → repository root (run ${{ github.run_id }})" || true
          fi

      - name: Create Promotion PR
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.BOT_PAT }}
          commit-message: "Bot: promote /foyer/ → repository root (run ${{ github.run_id }})"
          branch: "bot/promote-foyer-root-${{ github.run_id }}"
          title: "Promote /foyer/ artifacts to repository root (owner confirmed)"
          body: |
            Owner-triggered promotion of foyer artifacts to repository root.
            Promotion Record (created in this PR): pasture/archive/promotion-record-<timestamp>.md
            Note: merges to main must follow branch-protection and human-review requirements.
          labels: "auto-promote, needs-review"
